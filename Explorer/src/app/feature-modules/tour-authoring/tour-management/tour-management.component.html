<!-- tour-management.component.html -->

<!-- Main Tour Management View -->
<div class="tour-management-container" *ngIf="!showKeyPointManagement">
  <div class="header">
    <h1>Tour Management</h1>
    <button mat-raised-button color="primary" (click)="showCreateTourForm()" *ngIf="!showCreateForm">
      <mat-icon>add</mat-icon>
      Create New Tour
    </button>
  </div>

  <!-- Create/Edit Tour Form -->
  <div class="tour-form-container" *ngIf="showCreateForm">
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          {{ editingTour ? 'Edit Tour' : 'Create New Tour' }}
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <form [formGroup]="tourForm" (ngSubmit)="editingTour ? updateTour() : createTour()">
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Tour Name</mat-label>
              <input matInput formControlName="name" placeholder="Enter tour name">
              <mat-error *ngIf="name?.hasError('required') && name?.touched">
                Tour name is required
              </mat-error>
              <mat-error *ngIf="name?.hasError('minlength') && name?.touched">
                Tour name must be at least 3 characters long
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Description</mat-label>
              <textarea matInput formControlName="description" rows="4" 
                        placeholder="Describe the tour..."></textarea>
              <mat-error *ngIf="description?.hasError('required') && description?.touched">
                Description is required
              </mat-error>
              <mat-error *ngIf="description?.hasError('minlength') && description?.touched">
                Description must be at least 10 characters long
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Difficulty</mat-label>
              <mat-select formControlName="difficulty">
                <mat-option *ngFor="let diff of difficulties" [value]="diff.id">
                  {{ diff.name }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="difficulty?.hasError('required') && difficulty?.touched">
                Difficulty is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Category</mat-label>
              <mat-select formControlName="category">
                <mat-option *ngFor="let cat of categories" [value]="cat.id">
                  {{ cat.name }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="category?.hasError('required') && category?.touched">
                Category is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Price (€)</mat-label>
              <input matInput type="number" formControlName="price" min="0" step="0.01">
              <mat-error *ngIf="price?.hasError('required') && price?.touched">
                Price is required
              </mat-error>
              <mat-error *ngIf="price?.hasError('min') && price?.touched">
                Price must be 0 or greater
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Date & Time</mat-label>
              <input matInput type="datetime-local" formControlName="date">
              <mat-error *ngIf="date?.hasError('required') && date?.touched">
                Date and time are required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-actions">
            <button mat-button type="button" (click)="hideCreateForm()">
              Cancel
            </button>
            <button mat-raised-button color="primary" type="submit" 
                    [disabled]="tourForm.invalid">
              {{ editingTour ? 'Update Tour' : 'Create Tour' }}
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Tours List -->
  <div class="tours-list-container">
    <h2>Your Tours</h2>
    
    <div *ngIf="tours.length === 0" class="no-tours">
      <mat-icon>tour</mat-icon>
      <p>No tours created yet. Create your first tour to get started!</p>
    </div>

    <div class="tours-grid" *ngIf="tours.length > 0">
      <mat-card class="tour-card" *ngFor="let tour of tours">
        <mat-card-header>
          <mat-card-title>{{ tour.name }}</mat-card-title>
          <mat-card-subtitle>
            <span class="category-chip">{{ getCategoryName(tour.category) }}</span>
            <span class="difficulty-chip difficulty-{{ tour.difficulty }}">
              {{ getDifficultyName(tour.difficulty) }}
            </span>
          </mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <p class="tour-description">{{ tour.description }}</p>
          
          <div class="tour-details">
            <div class="detail-item">
              <mat-icon>euro</mat-icon>
              <span>€{{ tour.price }}</span>
            </div>
            <div class="detail-item">
              <mat-icon>schedule</mat-icon>
              <span>{{ tour.date | date:'short' }}</span>
            </div>
            <div class="detail-item">
              <mat-icon>info</mat-icon>
              <span class="state-badge" [class.draft]="tour.state === 0" [class.published]="tour.state === 1">
                {{ getTourStateName(tour.state) }}
              </span>
            </div>
          </div>
        </mat-card-content>

        <mat-card-actions>
          <button mat-button color="primary" (click)="editTour(tour)">
            <mat-icon>edit</mat-icon>
            Edit
          </button>

          <button mat-button color="accent" (click)="manageKeyPoints(tour)">
            <mat-icon>place</mat-icon>
            Key Points
          </button>
          
          <button mat-button color="accent" (click)="publishTour(tour)" 
                  *ngIf="tour.state === 0"
                  [disabled]="!tour.name || !tour.description">
            <mat-icon>publish</mat-icon>
            Publish
          </button>
          
          <button mat-button color="accent" (click)="requestReplacement(tour)" 
                  *ngIf="tour.state === 1 && isFutureTour(tour)"
                  matTooltip="Request another guide to take over this tour">
            <mat-icon>find_replace</mat-icon>
            Request Replacement
          </button>

          <button mat-button color="warn" (click)="deleteTour(tour.id)">
            <mat-icon>delete</mat-icon>
            Delete
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>
</div>

<!-- Key Point Management View -->
<div class="keypoint-view-container" *ngIf="showKeyPointManagement && selectedTour">
  <div class="keypoint-header">
    <button mat-icon-button (click)="backToTourList()" class="back-button">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <div class="header-info">
      <h1>Key Points for: {{ selectedTour.name }}</h1>
      <p class="tour-subtitle">{{ selectedTour.description }}</p>
    </div>
  </div>

  <app-keypoint-management 
    [tourId]="selectedTour.id" 
    [readOnly]="selectedTour.state === 1">
  </app-keypoint-management>
</div>