<div class="guide-problems-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Tour Problems - Guide Dashboard</mat-card-title>
      <button mat-raised-button color="primary" (click)="loadProblems()" [disabled]="loading">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </mat-card-header>

    <mat-card-content>
      <!-- Filter Chips -->
      <div class="filter-section">
        <mat-chip-set>
          <mat-chip (click)="onFilterChange('active')" [highlighted]="selectedFilter === 'active'">
            Active ({{ getStatusCount('active') }})
          </mat-chip>
          <mat-chip (click)="onFilterChange('all')" [highlighted]="selectedFilter === 'all'">
            All ({{ problems.length }})
          </mat-chip>
          <mat-chip (click)="onFilterChange('pending')" [highlighted]="selectedFilter === 'pending'">
            Na čekanju ({{ getStatusCount(0) }})
          </mat-chip>
          <mat-chip (click)="onFilterChange('underReview')" [highlighted]="selectedFilter === 'underReview'">
            Na reviziji ({{ getStatusCount(2) }})
          </mat-chip>
          <mat-chip (click)="onFilterChange('resolved')" [highlighted]="selectedFilter === 'resolved'">
            Rešeno ({{ getStatusCount(1) }})
          </mat-chip>
          <mat-chip (click)="onFilterChange('rejected')" [highlighted]="selectedFilter === 'rejected'">
            Odbačeno ({{ getStatusCount(3) }})
          </mat-chip>
        </mat-chip-set>
      </div>

      <!-- Loading Spinner -->
      <div *ngIf="loading" class="loading">
        <mat-spinner></mat-spinner>
      </div>

      <!-- Empty State -->
      <div *ngIf="!loading && filteredProblems.length === 0" class="empty-state">
        <mat-icon>check_circle</mat-icon>
        <p *ngIf="selectedFilter === 'active'">No active problems on your tours!</p>
        <p *ngIf="selectedFilter !== 'active'">No problems with this status</p>
      </div>

      <!-- Problems Table -->
      <div *ngIf="!loading && filteredProblems.length > 0" class="table-container">
        <table mat-table [dataSource]="filteredProblems" class="problems-table">

          <!-- Tour Name Column -->
          <ng-container matColumnDef="tourName">
            <th mat-header-cell *matHeaderCellDef>Tour</th>
            <td mat-cell *matCellDef="let problem">{{ problem.tourName }}</td>
          </ng-container>

          <!-- Title Column -->
          <ng-container matColumnDef="title">
            <th mat-header-cell *matHeaderCellDef>Problem Title</th>
            <td mat-cell *matCellDef="let problem">
              <strong>{{ problem.title }}</strong>
            </td>
          </ng-container>

          <!-- Description Column -->
          <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef>Description</th>
            <td mat-cell *matCellDef="let problem">
              <div class="description-cell">{{ problem.description }}</div>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let problem">
              <mat-chip [color]="getStatusColor(problem.status)" selected>
                {{ getStatusText(problem.statusName) }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Reported At Column -->
          <ng-container matColumnDef="reportedAt">
            <th mat-header-cell *matHeaderCellDef>Reported</th>
            <td mat-cell *matCellDef="let problem">
              {{ problem.reportedAt | date:'short' }}
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let problem">
              <div class="action-buttons">
                <button 
                  mat-raised-button 
                  color="primary" 
                  (click)="markAsResolved(problem)"
                  [disabled]="loading || !isPending(problem)"
                  matTooltip="Mark this problem as resolved"
                  *ngIf="isPending(problem)">
                  <mat-icon>check</mat-icon>
                  Resolve
                </button>
                
                <button 
                  mat-raised-button 
                  color="warn" 
                  (click)="sendToAdmin(problem)"
                  [disabled]="loading || !isPending(problem)"
                  matTooltip="Send to administrator for review"
                  *ngIf="isPending(problem)">
                  <mat-icon>send</mat-icon>
                  Send to Admin
                </button>

                <mat-chip 
                  *ngIf="isUnderReview(problem)" 
                  color="warn" 
                  selected>
                  <mat-icon>schedule</mat-icon>
                  Waiting for Admin
                </mat-chip>

                <span *ngIf="!isPending(problem) && !isUnderReview(problem)" class="final-status">
                  Final Status: {{ getStatusText(problem.statusName) }}
                </span>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>
</div>